<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="BitFire Dashboard" />

    <!-- Libs CSS -->
    <!--
    <link rel="stylesheet" href="https://bitfire.co/dash/flatpicker.min.css" />
    <link rel="stylesheet" href="https://bitfire.co/dash/feather.css" />
    <link rel="stylesheet" href="https://bitfire.co/dash/quill.core.css" />
    -->

	<link rel="shortcut icon" href="https://www.bitfire.co/favicon.ico">
    <link rel="stylesheet" href="https://www.bitfire.co/dash/vs2015.css" />

    <!-- Theme CSS -->
    <link rel="stylesheet" href="https://www.bitfire.co/dash/theme.min.css" id="stylesheetLight">
    <link rel="stylesheet" href="https://www.bitfire.co/dash/theme.bundle.css" id="stylesheetLight">
    <link rel="stylesheet" href="https://www.bitfire.co/assets/css/prism.css" id="stylesheetLight">
    <!--
    <link rel="stylesheet" href="https://www.bitfire.co/dash/theme-dark.min.css" id="stylesheetDark">
    -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js" type="text/javascript"></script>
    <script src="https://bitfire.co/assets/js/difflib.js" type="text/javascript"></script>
    <script src="https://bitfire.co/assets/js/prism.js" data-manual type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.2/underscore-umd-min.js" type="text/javascript"></script>

    <style>
.lds-dual-ring {
  display: inline-block;
  width: 64px;
  height: 64px;
  margin-top:-48px;
  margin-right:128px;
}
.lds-dual-ring:after {
  content: " ";
  display: block;
  width: 64px;
  height: 64px;
  margin: 8px;
  border-radius: 50%;
  border: 6px solid #fff;
  border-color: #1657af transparent #1657af transparent;
  animation: lds-dual-ring 1.2s linear infinite;
}
.add { background-color: rgba(0, 240, 0, 0.2); }
.remove { background-color: rgba(240, 0, 0, 0.2); }
.right { float: right; }
.left { float: left; }

.line_nums {
  width:50px;
  float:left;
  background-color: #ddd;
  padding:1 0 0 0;
  font-size:15px;
  line-height:22.5px;
}

@keyframes lds-dual-ring {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}
      .right { float: right; }
      .chilabel { color: #333; display: block; width: 140px; float: left; margin-right: 0; padding: .4rem 0 0 0!important; }
      /*
      .lnum { float: right; }
      */
      .pr1 { margin-top: 20px; }
      .card-body { padding: 0.5rem !important; }
      .center { text-align: center; }

      .zn1 { z-index: -1;}
      image.type { fill: #e63757; }

      svg { fill: #977; }
      .blue { fill: #30b7e5; color: #30b7e5; }
      svg.green { fill: #21d97e; }
      svg.yellow { fill: #f6c343; }
      svg.red { fill: #e63757; }
      img.red { filter: invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%); }
      img.grey_blue { filter: invert(82%) sepia(15%) saturate(597%) hue-rotate(184deg) brightness(89%) contrast(86%); }
      img.orange { filter: invert(83%) sepia(34%) saturate(523%) hue-rotate(336deg) brightness(98%) contrast(92%); }


      .oh { overflow: auto; }
      .wrap { white-space: break-spaces; line-break: anywhere; }
      .nowrap { white-space: nowrap; }
      
      .hidden { display: none; }
      
      .country { float: right; display: block; }

      .btn-sm {
        padding: 0.1rem .5rem !important;
        font-size: .4rem !important;
        font-weight: bold;
      }
      .btn-group-tiny>.btn {
        padding: .075rem .25rem;
        font-size: .4rem;
        line-height: 1.0;
        border-radius: .25rem;
      }
      .dropdown-toggle {
        width: 65px;
      }
      
      .nav-sm .nav-link {
        font-size: .6125rem;
      }

      .navbar-vertical.navbar-expand-md .navbar-nav .nav .nav-link {
        padding-left: .5rem;
        padding-right: 0rem;
      }
      
      /*
      ul.navbar-nav li.nav-item ul.nav li.nav-item { margin-bottom: -30px; }
      */
      /*
      .dropdown-menu { margin-top: -20px; }
      */
      .chilabel { margin-left: 1rem; }
      
      thead.details th, th { font-size: 12px; }
      
      .popover { max-width: 30rem; }
      .underline { text-decoration: underline; margin-bottom: 1rem; }
      .table-sm td { padding: .25rem; }
      .tbalt {
        color: #333;
		    overflow: hidden;
        background-color: #EFEFEF;
        font-family: monospace;
      }
      .tbalt td {
        border-bottom: 1px solid #CCC;
      }
      .table-sm th { padding: .5rem .25rem; }

      span.method { padding: .45rem .75rem; font-weight: bold; color #111; }
      tr.inforow td {
        background-image: linear-gradient(to bottom, rgba(240,240,240,0),92%, rgba(240,240,240,1)100%);
      }
    </style>
    
    <!-- Title -->
    <title>BitFire : Control Panel</title>

    <script>
        const page_tz = <?php echo date('Z'); ?>;
        const VERSION = <?php echo \BitFire\BITFIRE_VER; ?>;
        const VERSION_STR = "<?php echo \BitFire\BITFIRE_SYM_VER; ?>";
        const LLANG = "<?php echo $llang ?>";
        function GBI(name) { return document.getElementById(name); }

      /*
        window.ERROR = [];
        
        function url_to_path(url) {
          console.log(url);
          let s = url.indexOf("/");
          return url.substr(s);
        }

                
        // Example POST method implementation:
        async function postData(url = '', data = {}) {
          // Default options are marked with *
          const response = await fetch(url, {
            method: 'POST',
            mode: 'cors',
            cache: 'no-cache',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            redirect: 'follow',
            referrerPolicy: 'same-origin',
            body: JSON.stringify(data)
          });
          return response.text(); // parses JSON response into native JavaScript objects
        }

        function cc_to_flag(cc) {
          if (cc.length != 2) { return ""; }
          const OFFSET = 127397;
          const codePoints = [...cc.toUpperCase()].map(c => c.codePointAt() + OFFSET);
          return String.fromCodePoint(...codePoints);
        }

        
        const min_reducer = (accumulator, currentValue) => accumulator < currentValue ? accumulator : currentValue;
        const max_reducer = (accumulator, currentValue) => accumulator >= currentValue ? accumulator : currentValue;
        const cap = (s) => { if (typeof s !== 'string') return s; return s.charAt(0).toUpperCase() + s.slice(1); }
        
        function clamp(input, min, max) { return Math.min(Math.max(input, min), max); }

        function min(numbers) { return numbers.reduce(min_reducer); }
        function max(numbers) { return numbers.reduce(max_reducer); }
        function avg(numbers) { return numbers.reduce((a, b) => (a + b)) / numbers.length; }


        function update_challenge(data) {
          if (GBI("check")) { 
            console.log(data);
            GBI("check").innerText = data.challenge;
            GBI("pass").innerText = data.valid;
          }
        }

        function mode(numbers) {
            // as result can be bimodal or multi-modal,
            // the returned result is provided as an array
            // mode of [3, 5, 4, 4, 1, 1, 2, 3] = [1, 3, 4]
            var modes = [], count = [], i, number, maxIndex = 0;
         
            for (i = 0; i < numbers.length; i += 1) {
                number = numbers[i];
                count[number] = (count[number] || 0) + 1;
                if (count[number] > maxIndex) {
                    maxIndex = count[number];
                }
            }
         
            for (i in count)
                if (count.hasOwnProperty(i)) {
                    if (count[i] === maxIndex) {
                        modes.push(Number(i));
                    }
                }
         
            return modes.pop();
        }


               
       
        //
        //  @param string type  primary, secondary, success, danger, warning, info
        // @param string message a value with the error content (can include HTML markup)
        // 
        function add_info(type, message) {
          let msg = {"type": type, "message": message};
          if (window.ERROR.length > 5) {
              window.ERROR.pop();
          }
          window.ERROR.unshift(msg);
          

          GBI("error").innerHTML = window.ERROR.reduce((accumulator, value) =>
          accumulator + "<div class='alert alert-"+value.type+"' role='alert'>" + value.message + "</div>", '');
        }

        function avg_click(e) {
            window.CHITON_AVG = !window.CHITON_AVG;
        }
*/

    </script>
  </head>

  <body>


        
       

    <!-- MAIN CONTENT
    ================================================== -->
    <div class="main-content">
      
    <!-- HEADER -->
      <div class="header">
        <div class="container-fluid">

          <!-- Body -->
          <div class="header-body">
            <div class="row align-items-end">
              <div class="col">
                <!-- Pretitle -->
                <h6 class="header-pretitle">
                  BitFire <?php echo ($is_free) ? "FREE" : "PRO" ?> : Release <?php echo \BitFire\BITFIRE_SYM_VER?>
                </h6>
                <p style="font-size:.75rem;color:#666;">
                <?php if ($is_free) { ?>
                  <a href="https://bitfire.co/pricing" target="_blank">Upgrade</a> to <span class="blue font-weight-bold">PRO</span> to enable File-Lock to prevent file modification, WordPress integrity check, Redirect protection and Multi Factor Authentication
                <?php } ?>

                <!-- Title -->
                <h1 class="header-title">
                  <img src="https://bitfire.co/assets/img/shield.png" class="navbar-brand-img mx-auto" alt="...">
                  <?php echo $page_name; ?>
                </h1>

              </div>
              <div class="col-auto">

                <!-- Buttons -->
                <a href="https://bitfire.co/support-center" target="_blank" class="btn btn-success lift bold" id="dwn_link"><strong>Support Center</strong></a>
                <a href="https://github.com/bitslip6/bitfire/issues" target="_blank" class="btn btn-warning lift" id="dwn_link"><strong>Report Issues</strong></a>
              </div>
            </div> 


            <div class="row align-items-center">
              <div class="col">

                <ul class="nav nav-tabs nav-overflow header-tabs">
                  <li class="nav-item">
                    <a href="<?php echo $self;?>?BITFIRE_API=DASHBOARD" class="nav-link grow">
                      Dashboard
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="<?php echo $self;?>?BITFIRE_API=MALWARESCAN" class="nav-link grow">
                      Malware Scan
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="<?php echo $self;?>?BITFIRE_API=SETTINGS" class="nav-link grow">
                      Settings
                    </a>
                  </li>
                  <li>
        <div class="left mt-3">
          <div id="unlock_div" <?php if (!$locked) { echo 'class="hidden"'; }?>>
          <svg height="24px" viewBox="0 0 24 24" width="24px" fill="black"><path d="M0 0h24v24H0z" fill="none"/><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
          <button id="unlock" type="button" class="btn btn-danger lift">UNLOCK SITE</button>
          </div>
          <div id="lock_div" <?php if ($locked) { echo 'class="hidden"'; }?>>
          <svg height="24px" viewBox="0 0 24 24" width="24px" fill="black"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/></svg>
          <button id="lock" type="button" class="btn btn-success lift">LOCK SITE</button>
          </div>
        </div>

                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div> 



      <div class="container-fluid">
        <?php if ($is_free) { ?>
      <div class="row">
          <div class="col-12">
          <div class="card-body bg-warning-soft">
              <h3 class="card-header-title">Limited Signature Library</h3>
              <br>
                  <p>
              The free version of BitFire can only detect modified file hashes and potential malware.  
              </p>
              <p>
              To view these changed files and automatically repair them, <a href="https://bitfire.co/pricing" target="_blank">please upgrade to BitFire PRO.</a>
              </p>
          </div>
          </div>
      </div>
      <?php } ?>
      
      <div class="row">
          <div class="col-12">

          <div class="card-header">

                <h4 class="card-header-title">
                  Wordpress <?php echo $file_list['ver'] . ' - 
                  <span id="count_files" class="text-muted" data-count="'.$file_list['count'].'">('.($file_list['count']).') > Scanned Files </span>
                  <span id="num_files" class="text-muted">('.count($file_list['files']).") "; ?> Changed Files </span>
                  <div id="files_spin" class="spinner-border text-secondary spinner-border-sm mt-1 ml-4" role="status"></div>
                </h4>

                <div id="spinner" class="lds-dual-ring"></div>
               <!-- Form -->
                <!--form>
                  <div class="input-group input-group-flush input-group-merge input-group-reverse">

                    <input class="form-control list-search" type="search" placeholder="Search">

                    <div class="input-group-text">
                      <span class="fe fe-file"></span>
                    </div>

                  </div>
                </form-->

              </div>
              <div class="card-body">

                <div id="status" class="alert alert-success" role="alert">Wordpress integrity check: <span id="status_amt">100%</span></div>

                <!-- List -->
                <ul class="list-group list-group-lg list-group-flush list my-n4" id="files_ul">
                </ul>

              </div>
            </div>

          </div>
        </div> <!-- / .row -->
        </div>
      
    



    </div><!-- / .main-content -->

    <!-- JAVASCRIPT
    ================================================== -->
    <!-- Libs JS -->
    <script src="https://www.bitfire.co/dash/bootstrap.bundle.min.js"></script>
    <script src="https://www.bitfire.co/dash/chart.min.js"></script>
    <!--
    <script src="https://bitfire.co/dash/flatpicker.min.js"></script>
    <script src="https://bitfire.co/dash/dropzone.min.js"></script>
    <script src="https://bitfire.co/dash/autosize.min.js"></script>
    <script src="https://bitfire.co/dash/highlight.pack.min.js"></script>
    <script src="https://bitfire.co/dash/quill.min.js"></script>
    -->
    <script src="https://www.bitfire.co/dash/jquery.mask.min.js"></script>
    <script src="https://www.bitfire.co/dash/list.min.js"></script>
    <script src="https://www.bitfire.co/dash/select2.min.js"></script>
    <script src="https://www.bitfire.co/dash/Chart.extension.js"></script>

    <script>
    </script>


    <script type="text/template" id="hash_template">
      <li class="list-group-item " id="file<%=crc_trim%>">
        <div class="row align-items-center" id="info<%=crc_trim%>">
          <div class="col-auto">
            <img id="icon<%=crc_trim%>" src="https://bitfire.co/assets/php-file.png" width="32" height="32" />
          </div>
          <div class="col ms-n2">

            <h4 class="mb-1 name">
              <a href="#!"><%=out%></a>
            </h4>

            <p class="card-text small text-muted mb-1">
              <span style="margin-right:50px;"><span class='badge <%=bgclass%>'><i class='fe <%=icon%>'></i> <%=type%> </span>  Expected / Actual: </span><span class="text-info"><%=kb2%></span> / <span class='text-primary'><%=kb1%></span>
            </p>

            <p class="card-text small text-muted">
              Modified on: <time class="text-primary" data-out="<%=out%>" data-offset="<%=page_tz%>" data-mtime="<%=mtime%>" datetime="<%=machine_date%>"></time> <small class="text-muted"> local time </small>
            </p>
            
          </div>
          <div class="col-auto" id="action_list<%=crc_trim%>">

            <?php if (!$is_free) { ?>
              <button style="font-size:.75rem;" onclick="postData('<%=self_url%>?BITFIRE_API=repair', {'filename':'<%=out%>','_bitfire_p':'<?php echo \BitFire\Config::str("secret")?>','url':'<%=url%>', 'id':'<%=crc_trim%>'}, repaired);" class="btn btn-white d-none d-md-inline-block" title="replace this file with the master copy from wordpress.org">
            <?php } else { ?>
              <button style="font-size:.75rem;" onclick="alert('Upgrade to PRO to access 10,000,000 WordPress file datapoints and auto repair this file.');" class="btn btn-white d-none d-md-inline-block" title="replace this file with the master copy from wordpress.org">
            <?php } ?>
              <span class="fe fe-check-square"></span>
              Repair
            </button>

            <a style="font-size:.75rem;" href="<%=self_url%>?filename=<%=out%>&BITFIRE_API=download&_bitfire_p=<?php echo \BitFire\Config::str("secret");?>" class="btn btn-white d-none d-md-inline-block" title="download this file">
              <span class="fe fe-download"></span>
              Download
            </a>
            
            <button style="font-size:.75rem;" role="button" title="show diff for file" onclick="showdiff('<%=out%>', '<%=url%>', '<%=crc_trim%>', true)" class="btn btn-white d-none d-md-inline-block">
              <span class="fe fe-copy"></span>
              Diff
            </button>
            <a href="#diff<%=crc_trim%>" style="font-size:.75rem;" role="button" title="delete this file" onclick="del('<%=out%>', '<%=url%>', '<%=crc_trim%>', '<%=size2%>')" class="btn btn-white d-none d-md-inline-block">
              <span class="fe fe-trash-2"></span>
            </a>

          </div>
        </div>
        <div class="row diffrow collapse" id="diff_cont<%=crc_trim%>">
          <a name="#anchor<%=crc_trim%>"></a>
          <svg style="float:right;cursor:pointer;" onclick="classtoggle('collapse', 'diff_cont<%=crc_trim%>')" class=""width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z"/><rect fill="#335EEA" opacity=".3" x="11" y="7" width="2" height="14" rx="1"/><path d="M6.707 14.707a1 1 0 11-1.414-1.414l6-6a1 1 0 011.383-.03l6 5.5a1 1 0 11-1.352 1.474L12.03 9.384l-5.323 5.323z" fill="#335EEA"/><rect fill="#335EEA" opacity=".3" x="3" y="3" width="18" height="2" rx="1"/></g></svg>
          <pre id="line_data<%=crc_trim%>" class="mb-0 line_nums"></code></pre>
          <div id="diff_data<%=crc_trim%>" style="width:90%; overflow-wrap:anywhere;float:left;" class="mb-0 language-php"></div>
        </div>
      </li>
    </script>






    <!-- Theme JS -->
    <script src="https://www.bitfire.co/dash/dashkit.min.js"></script>


    
      <div class="modal fade" id="password_set" role="dialog" data-backdrop="static" data-keyboard="false" tabindex="-1">
        <div class="modal-dialog" role="document" id="password_set2">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="pass_title">Set BitFire Password</h5>
              <!--
              <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
              -->
            </div>
            <div class="modal-body">
              <p>BitFire password is required to access the dashboard.  If you forget the password, change the "password" configuration item in config.ini to "default" to relaunch this modal or set it to the SHA1 value of your password</p>
              <label style="width:150px;">Password:</label>
              <input id="pass1" type="password" name="pass1" /><br />
              <label style="width:150px;">Repeat Password:</label>
              <input id="pass2" type="password" name="pass1" />
            </div>
            <div class="modal-footer">
              <button id="password_close" type="button" class="btn btn-secondary hidden" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="save_pass">Save Password</button>
            </div>
          </div>
        </div>
      </div>

    <script type="text/javascript">

    function repaired (response, data) { 
      console.log(response);
      console.log(data);
      if (response.success) { 
        let e = document.getElementById("action_list"+data.id);
        e.innerHTML = "<h3 class='text-primary btn'>File Repaired</h3>"
        e = document.getElementById("diff_cont"+data.id).classList.add("collapse");
        document.getElementById("icon"+data.id).src="https://bitfire.co/assets/php-file.png";
      } else { 
        alert("unable to repair file: "+ response.error);
      }
    };



    // Example POST method implementation:
    async function postData(url = '', data = {}, fn = null) {
      // Default options are marked with *
      fetch(url, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-cache',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        redirect: 'follow',
        referrerPolicy: 'same-origin',
        body: JSON.stringify(data)
      })
      .then(r => { return r.json() })
      .then(result => { 
        if (fn != null) { fn(result, data); }
      });
    }

    
function add_core_url(ver, data) {
  data.url = "https://core.svn.wordpress.org/tags/"+ver+"/"+data.path;
  return data;
}

// render the list of files generated on the page
var diffed = {};
var self_url = '<?php echo $self;?>';
var file_list = <?php echo json_encode($file_list['files']); ?>;
var num_files = 0;

var content = GBI("hash_template");
var hash_renderer = _.template(content.innerText);
var output = _.map(file_list, hash_renderer).join("");
GBI("files_ul").innerHTML += output;
// diff each file ...
_.each(file_list, (elm) => {
  showdiff(elm.out, elm.url, elm.crc_trim);
});

var dir_ver = {<?php foreach($dir_list as $dir => $ver) { echo "'$dir': '$ver', "; } ?>};
var dirs = [<?php foreach($dir_list as $dir => $ver) { echo "'$dir', "; } ?>];
var dir_idx = 0;

var testans = function(response) {

  //console.log("test ans");

  let new_files = JSON.parse(atob(response.data));
  let cf = GBI("count_files");
  let cnt = parseInt(cf.getAttribute("data-count"));
  if (cnt > 0) {
    console.log(new_files);
    cf.setAttribute("data-count", cnt+new_files.count);
    cf.innerText = "(" + cnt + ") Scanned Files";
  }

  let content = GBI("hash_template");
  let hash_renderer = _.template(content.innerText);
  //console.log(new_files);
  //console.log(new_files.files);
  var output = _.map(new_files.files, hash_renderer).join("");
  GBI("files_ul").innerHTML += output;
  _.each(new_files.files, (elm) => {
    //console.log("ELM", elm);
    showdiff(elm.out, elm.url, elm.crc_trim);
  });

  if (dir_idx <= dirs.length) {
    dir_idx++;
    if (String(dirs[dir_idx]).length > 2) {
      // console.log("reload ", dir_idx, dirs, dirs[dir_idx]);
      postData("<?php echo $self?>?BITFIRE_API=dump_hash_dir",
        {"BITFIRE_API":"dump_hash_dir",
          "_bitfire_p": "<?php echo \Bitfire\Config::str("secret");?>",
          "dir": dirs[dir_idx],
          "ver": dir_ver[dirs[dir_idx]],
        }, testans);
    }
    else { 
      // console.log("skip ", dir_idx, dirs, dirs[dir_idx]);
      testans();
    }
  } 
  // all done!
  else { GBI("files_spin").classList.add("hidden"); }

  update_times();
};


postData("<?php echo $self?>?BITFIRE_API=dump_hash_dir",
    {"BITFIRE_API":"dump_hash_dir",
      "_bitfire_p": "<?php echo \Bitfire\Config::str("secret");?>",
      "dir": dirs[dir_idx],
      "ver": dir_ver[dirs[dir_idx]],
    }, testans);






// TODO: highlight the evil
// TODO: show removed lines in red, added lines in green
function showdiff(path, url, id, do_toggle=false) {

  const out = document.getElementById("diff_cont"+id);
  if (diffed[id]) { <?php if($is_free) { echo "\nalert('Upgrade to PRO to access over 10,000,000 WordPress file datapoints and view and repair these file changes');\n"; } else { echo "\nout.classList.toggle('collapse');\n"; } ?> return; }
  //else { out.classList.remove("collapse"); }
  diffed[id] = true;
  //if (!out.classList.contains("collapse")) { console.log("no rediff"); return; }
  
  let ans = function(data) {


    // continue here, looks like it's now showing the diff for some reason, data has local and remote base64 encoded files...
    let t1 = atob(data.orig);
    let t2 = atob(data.local);
    
    let l1 = difflib.stringAsLines(t1);
    let l2 = difflib.stringAsLines(t2);
    let sm = new difflib.SequenceMatcher(l1, l2);
    let ops = sm.get_opcodes();
    let e = document.getElementById("diff_data"+id);
    let e2 = document.getElementById("line_data"+id);
    let html = ""
    let line_nums = ""
    let has_diff = false;
    let is_evil = false;
    for (i=0;i<ops.length;i++) {
      if (ops[i][0] == "insert") {
        num_replace = 0;
        has_diff = true;
        let last_line = ops[i][4]-1;
        // html += "// Local File ADDS Lines: " + ops[i][3] + " - " + last_line + "<br />\n";
        html2 = "";
        for(j=ops[i][3]; j<ops[i][4]; j++) {
          if (l2[j].includes("/bitfire/startup.php")) { has_diff = false; } // ignore our bitfire include
          else {
            let evil_line = evil(l2[j]);
            if (num_replace++ < 100) {
              line_nums += j + "\n";
              let markup = Prism.highlight(l2[j], Prism.languages.php, 'php') + "<br />\n";
              html2 += (evil_line) ? "<div class='evil'>" + markup + "</div>": markup;
            }
            is_evil |= evil_line;
          }
        }
        if (is_evil)
        if (num_replace >= 100) { html += " /* ... " + (100 - num_replace) + " lines truncated... */\n"; line_nums += "\n"; }
        html += "<div class='add'>"+html2+"\n</div>\n";
        //line_nums += "\n";
      }
      else if (ops[i][0] == "replace") {
        has_diff = true;
        num_replace = 0;
        let last_line = ops[i][4]-1;
        html += "// ORIGINAL LINES: " + ops[i][3] + " - " + last_line + "<br />\n";
        line_nums += "\n";
        for(j=ops[i][1]; j<ops[i][2] && num_replace++ < 10; j++) {
          html += Prism.highlight(l1[j], Prism.languages.php, 'php') + "<br />\n";
          line_nums += j + "\n";
        }
        if (num_replace >= 10) { html += " /* ... " + (100 - num_replace) + " lines truncated... */\n"; line_nums += "\n"; }

        num_replace = 0;
        last_line = ops[i][2]-1;
        html += "// REPLACED LINES: " + ops[i][1] + " - " + ops[i][2] + "<br />\n";
        line_nums += "\n";
        for(j=ops[i][3]; j<ops[i][4]; j++) {
          if (num_replace++ < 100) { line_nums += j + "\n"; html += Prism.highlight(l2[j], Prism.languages.php, 'php') + "<br />\n"; }
          is_evil |= evil(l2[j]);
        }
        if (num_replace >= 100) { html += " /* ... " + (100 - num_replace) + " lines truncated... */\n"; line_nums += "\n"; }

        html += "\n";
        line_nums += "\n";
      }
    }
    // console.log(has_diff, html);
    if (has_diff) {
      num_files++;
      if (is_evil) {
          document.getElementById("icon"+id).src="https://bitfire.co/assets/malware.png";
          if (!do_toggle) {
              document.getElementById("diff_cont"+id).classList.remove("collapse");
          }
          document.getElementById("info"+id).classList.add("bg-danger-soft");
      }
    } else {
      document.getElementById("file"+id).classList.add("collapse");

      postData("https://bitfire.co/stow.php",
      { "url": data.url,
        "out": data.out,
        "content": data.local
      });

      }
    document.getElementById("num_files").innerText = " (" + num_files + ") Changed Files"
    <?php if (!$is_free) { echo "\ne.innerHTML = html;\ne2.innerText = line_nums.trim();\n"; } else {  } ?>
  }


  console.log("url: ", url);
  postData("<?php echo $self?>?BITFIRE_API=diff",
    {"BITFIRE_API":"diff",
      "_bitfire_p": "<?php echo \Bitfire\Config::str("secret");?>",
      "url": url,
      "out": path}, ans);
  return;
}

function evil(line) { 
  if (line.length>256) { let nfunc = line.split(';').length; if (nfunc > 6) { return true; } }
  let r = /\$[a-zA-Z_\x80-\xff][a-zA-Z0-9_\x80-\xff]*\s*\(/; if (r.exec(line)) { return true; }
  if (line.includes("ocation") && line.includes("header")) { return true; }
  let funcs = ['base64_decode', 'uudecode', 'ord', 'chr', 'eval', 'proc_open', 'pcntl_exec', 'exec', 'shell_exec', 'call_user_func', 'call_user_func_array', 'system', 'passthru', 'shell_exec', 'uploaded_file'];
  let result = funcs.reduce((val, e) => {
    let reg = new RegExp(e+'\\s*\\(', 'i');
    if (reg.exec(line)) { val=true; } return val;
  }, false);
  if (result) { 
    console.log("evil detected");
    let s = GBI("status");
    s.classList.remove("alert-success");
    s.classList.remove("alert-warning");
    s.classList.add("alert-danger");
    s.innerHTML = "Wordpress integrity check: Possible Malware Detected - <strong class='right text-decoration-underline'><a href='https://bitfire.co/pricing' class='text-light' target='_blank'>Upgrade to auto-repair<span class='fe fe-external-link'></span></a></strong>";
  }
  return result;
}

function del(path, url, actual, size) {
  if (size > 2) { alert("This is a wordpress file.  Please repair it instead."); return; }
  let result = confirm("Are you sure you want to delete " + path + " ?");
  if (result) { console.log("delete: " + path); document.getElementById("file"+actual).classList.add("collapse"); 
    fetch('<?php echo $dashboard_path?>?value='+path+'&BITFIRE_API=delete&_bitfire_p=<?php echo \Bitfire\Config::str("secret");?>&ts='+Date.now()).then(data => data.json()).then(e => { console.log(e); alert("file " + e.result); });
  }
}

function classtoggle(classname, id) {
  document.getElementById(id).classList.toggle(classname);
}

function toggle_id(param, value_id) {
    let e = GBI(value_id);
    fetch('<?php echo $dashboard_path?>?param='+elm+'&value='+e.value+'&BITFIRE_API=toggle_config_value&_bitfire_p=<?php echo \Bitfire\Config::str("secret");?>&ts='+Date.now()).then(data => { console.log(data); });
    return false;
}

function toggle(elm, type) {
    var e = GBI(elm);
    console.log("toggle elm", e);
    e.innerText = cap(type);
    fetch('<?php echo $dashboard_path?>?param='+elm+'&value='+type+'&BITFIRE_API=toggle_config_value&_bitfire_p=<?php echo \Bitfire\Config::str("secret");?>&ts='+Date.now()).then(data => { console.log(data); });
    if (type == "block" || type == "on" || type == "true") {
        e.classList.remove("btn-warning");
        e.classList.remove("btn-secondary");
        e.classList.add("btn-success");
    } else if (type == "report" || type == "alert") {
        e.classList.remove("btn-success");
        e.classList.remove("btn-secondary");
        e.classList.add("btn-warning");
    } else {
        e.classList.remove("btn-success");
        e.classList.remove("btn-warning");
        e.classList.add("btn-secondary");
    }
}





    GBI("lock").addEventListener("click", function() {
        <?php if ($is_free) {
        echo "alert('Site Lock only available in PRO');\nreturn;"; } ?>
        GBI("lock").innerText = "locking...";
        fetch('<?php echo $dashboard_path?>?BITFIRE_API=lock_site&_bitfire_p=<?php echo \Bitfire\Config::str("secret");?>&ts='+Date.now())
        .then(response => {
          console.log(response); 
          GBI("lock").innerText = "LOCK SITE";
          GBI("unlock_div").classList.remove("hidden");
          GBI("lock_div").classList.add("hidden");
        });
      });     

      GBI("unlock").addEventListener("click", function() {
        GBI("unlock").innerText = "unlocking...";
        fetch('<?php echo $dashboard_path?>?BITFIRE_API=unlock_site&_bitfire_p=<?php echo \Bitfire\Config::str("secret");?>&ts='+Date.now())
        .then(response => {
          console.log(response); 
          GBI("unlock").innerText = "UNLOCK SITE";
          GBI("lock_div").classList.remove("hidden");
          GBI("unlock_div").classList.add("hidden");
        });
      });  



function fp(info, ...parts) {
    return parts.reduce((accumulator, value) => {
        for (let x in info) {
            if (value == info[x].type) {
                return accumulator + info[x].value;
            }
        }
        return accumulator + value;
    }, "");
}

/*
file_list.forEach(elm => {
  showdiff(elm['path'], elm['url'], elm['actual']);
  document.getElementById("file"+elm['actual']).classList.remove("collapse");
});
*/
document.getElementById("spinner").classList.add("collapse");


function update_times() {
  var times = document.getElementsByTagName("time");
  let formatter = new Intl.DateTimeFormat(LLANG, {weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true})
  for (var i=0; i<times.length; i++) {
    let ts = parseInt(times[i].getAttribute("data-mtime"));
    let d = formatter.formatToParts(new Date(ts*1000));

    let markup = "<span class='text-primary'>"+fp(d, 'weekday', ', ', 'month', ' ', 'day') + "</span> " +
      "<span class='text-muted'>"+fp(d, 'year')+" @</span>" +
      "<span class='text-info'>"+fp(d, 'hour', ':', 'minute', ':', 'second', ' ', 'dayPeriod') + "</span>";
      times[i].innerHTML = markup;
  }
}
update_times();
  </script>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2YZ4QCZJHC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2YZ4QCZJHC');
</script>

  </body>
</html>
